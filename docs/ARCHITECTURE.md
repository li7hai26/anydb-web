# AnyDB Web 架构设计文档

## 项目概述
AnyDB Web是一款开源的数据库管理软件，支持连接和管理多种数据库服务。

## 支持的数据库
- 关系型数据库：MySQL、PostgreSQL、Oracle、MariaDB、SQLServer、DB2、TiDB、OceanBase
- NoSQL数据库：Redis、MongoDB、Elasticsearch、Zookeeper、Etcd
- 时序数据库：TDEngine
- 消息队列：Kafka
- 分布式查询：ClickHouse、Presto、Trino

## 架构设计

### 核心原则
1. **按需连接**：只在用户配置时才连接外部数据库
2. **启动快速**：应用启动时不依赖外部服务
3. **连接复用**：使用连接池管理数据库连接
4. **配置持久化**：使用MySQL存储用户配置信息

### 分层架构

#### 1. 前端层 (React + Vite)
- **页面模块**：数据库管理、SQL编辑器、性能监控、系统设置
- **状态管理**：React Hooks + Context API
- **UI组件**：Ant Design + Monaco Editor

#### 2. API网关层 (Spring Boot Web)
- **控制器**：处理HTTP请求和响应
- **验证**：请求参数验证和权限控制
- **文档**：Swagger/OpenAPI文档

#### 3. 业务服务层
- **DatabaseConfigService**：数据库配置管理
- **SQLExecutionService**：SQL语句执行
- **MonitoringService**：性能监控
- **ConnectionManager**：连接生命周期管理

#### 4. 连接管理层 (核心)
- **ConnectionManager**：按需连接管理
- **PoolManager**：连接池管理
- **ConnectorFactory**：连接器工厂模式
- **HealthChecker**：健康检查

#### 5. 数据访问层
- **MySQL**：存储用户配置、连接信息、操作日志
- **Repository**：数据访问对象
- **Entity**：数据模型

### 连接管理机制

#### 启动流程
1. 启动Spring Boot应用
2. 初始化MySQL连接（用于持久化配置）
3. 启动Web服务
4. 等待用户配置数据库连接

#### 连接流程
1. **配置添加**：用户在前端添加数据库配置
2. **测试连接**：后端验证连接信息
3. **创建连接池**：成功验证后创建连接池实例
4. **连接使用**：用户执行SQL时使用连接池
5. **连接清理**：配置删除或应用关闭时清理连接池

#### 连接池管理
- **连接池配置**：最大连接数、超时时间、连接验证
- **生命周期**：创建、使用、监控、销毁
- **健康检查**：定期检查连接池状态
- **异常处理**：连接失败重试、熔断机制

### 技术栈

#### 后端技术栈
- **框架**：Spring Boot 3.2.1
- **语言**：Java 17
- **构建工具**：Maven
- **持久化**：Spring Data JPA + MyBatis Plus
- **数据库**：MySQL 8.0
- **连接池**：Druid
- **日志**：SLF4J + Logback

#### 前端技术栈
- **框架**：React 18
- **构建工具**：Vite 5
- **语言**：TypeScript
- **UI库**：Ant Design
- **代码编辑器**：Monaco Editor
- **状态管理**：React Hooks

### 安全设计
- **配置加密**：敏感信息加密存储
- **连接隔离**：不同用户连接隔离
- **权限控制**：基于角色的访问控制
- **审计日志**：记录所有数据库操作

### 监控设计
- **连接监控**：实时监控连接池状态
- **性能监控**：SQL执行时间、结果数量
- **错误监控**：连接失败、SQL执行异常
- **资源监控**：CPU、内存、磁盘使用情况

### 部署架构
```
┌─────────────────────────────────────────────────────────────┐
│                      负载均衡器                             │
│                      (Nginx)                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                    应用服务器                               │
│              (Docker容器)                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 前端服务    │ │ 后端服务    │ │ Redis缓存   │           │
│  │(React+Nginx)│ │(Spring Boot)│ │ (可选)      │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                    数据存储层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ MySQL       │ │ 目标数据库  │ │ 用户配置    │           │
│  │(持久化存储) │ │(按需连接)   │ │(加密存储)   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 开发规范
- **代码规范**：阿里巴巴Java开发手册
- **接口设计**：RESTful API设计原则
- **错误处理**：统一的异常处理机制
- **日志规范**：结构化日志记录
- **测试规范**：单元测试 + 集成测试

### 扩展性设计
- **插件化**：支持自定义数据库连接器
- **水平扩展**：支持集群部署
- **微服务**：可拆分为独立的微服务
- **多租户**：支持多用户环境

## 开发指南

### 添加新的数据库支持
1. 创建数据库连接器实现`DatabaseConnector`接口
2. 在`DatabaseType`枚举中添加数据库类型
3. 在连接器工厂中注册新的连接器
4. 添加对应的前端UI组件

### 性能优化
1. 连接池参数调优
2. SQL执行计划优化
3. 缓存策略优化
4. 前端性能优化

### 运维监控
1. 应用程序监控
2. 数据库连接监控
3. 性能指标监控
4. 日志分析和告警
